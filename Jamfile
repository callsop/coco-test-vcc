
#################################################################
# common rules
#################################################################

# all configurations to build
CONFIGS = debug release directx opengl dbgaudio logging ;

rule SubDirSetup
{
	# locate output targets for each config
	rule SetLocateTarget cfg
	{
		LOCATE_TARGET on $(cfg) = [ FDirName build $(cfg) $(SUBDIR_TOKENS) ] ;
	}

	ForEachConfig $(CONFIGS) : SetLocateTarget ;

	# reset all subdir options to default
	SUBDIR$(SUBDIRRESET) on $(CONFIGS) = ;
}

SUBDIRRULES = SubDirSetup ;

#################################################################
# vcc build
#################################################################

SubDir TOP ;

# set where the sources are located
SEARCH_SOURCE = VCC ;

# collect the sources
SRCS = [ Glob $(SEARCH_SOURCE) : *.cpp *.rc ] ;

# collect all roms
ROMS = [ Glob roms : *.rom ] ;

# extra includes for vcc
3RDPARTY = [ FDirName VCC 3rdParty ] ;
COMMONLIB = [ FDirName VCC libcommon include ] ;

rule ConfigureBuild
{
	Promote SUBDIRC++FLAGS : $(CONFIGS) ;
	Promote SUBDIRC++FLAGS : directx opengl : release ;
	Promote SUBDIRC++FLAGS : dbgaudio logging : debug ;

	# libraries required
	SubDirLinkLibs kernel32.lib user32.lib gdi32.lib dsound.lib ddraw.lib ;
	SubDirLinkLibs dinput8.lib dxguid.lib winmm.lib shell32.lib comdlg32.lib ;
	SubDirLinkLibs comctl32.lib ;

	Promote SUBDIRLINKFLAGS SUBDIRLINKLIBS : $(CONFIGS) ;

	# configuration specific compilation flags
	ConfigSubDirC++Flags $(CONFIGS) : /I$(3RDPARTY) /I$(COMMONLIB) /D_CRT_SECURE_NO_WARNINGS ;
	ConfigSubDirC++Flags directx : /DUSE_OPENGL=false ;
	ConfigSubDirC++Flags opengl : /DUSE_DIRECTX=false ;
	ConfigSubDirC++Flags dbgaudio : /DUSE_DEBUG_AUDIOTAPE=true ;
	ConfigSubDirC++Flags logging : /DUSE_LOGGING=true ;
}

# copy a rom to the configuration output
rule MakeRom
{
	File $(<) : $(>) ;
	Depends $(<) : $(>) ;
	MakeLocate $(<) : $(LOCATE_TARGET) ;
	Depends roms $(cfg) : $(<) ;
	Clean clean : $(<) ;
}

# process all rom files
rule MakeRoms
{
	local rom ;
	for rom in $(ROMS)
	{
		MakeRom [ FGristFiles $(rom:BS) ] : $(rom) ;
	}
	NotFile roms ;
}

rule MakeTarget targetname
{
    # set sources grist based on config
    local SOURCE_GRIST = [ FGrist $(SUBDIR_TOKENS) $(cfg) ] ;

    # config specific target to build
    local target = [ FGristFiles $(targetname) ] ;	

	return $(target:S=$(SUFEXE)) ;
}

rule MakeExtras cfg
{
    # set sources grist based on config
    local SOURCE_GRIST = $(cfg) ;

	MakeRoms $(cfg) ;
}

rule ConfigLinkPath
{
	local target = [ MakeTarget vcc ] ;
	local libpath = [ FDirName $(LOCATE_TARGET) libcommon ] ;

	LINKPATH on $(target) = $(LINKPATH) $(libpath) ;

	Depends $(target) : $(libpath:S=.dll) ;
}

SubDirLinkFlags /SUBSYSTEM:WINDOWS ;
SubDirLinkLibs libcommon.lib ;
ConfigureBuild ;
ForEachConfig $(CONFIGS) : ConfigLinkPath ;

# build main debug/release versions
ConfigMain $(CONFIGS) : vcc : $(SRCS) ;

# build extras needed
ForEachConfig $(CONFIGS) : MakeExtras ;


rule MakeDllExtras cfg
{
	local SOURCE_GRIST = [ FGrist $(SUBDIR_TOKENS) $(cfg) ] ;

	local target = [ FAppendSuffix [ FGristFiles $(name) ] : $(SUFEXE) ] ;

	SOURCE_GRIST = [ FGrist $(cfg) ] ;

	local out = [ FAppendSuffix [ FGristFiles $(name) ] : $(SUFEXE) ] ;

	File $(out) : $(target) ;
	MakeLocate $(out) : [ FDirName build $(cfg) ] ;
	Depends $(cfg) : $(out) ;
}

rule BuildDll name : shared : libs
{
	SubDir TOP $(name) ;

	local SEARCH_SOURCE = [ FDirName VCC $(name) ] ;
	local SRCS = [ Glob $(SEARCH_SOURCE) : *.c *.cpp *.rc ] ;

	# shared 
	SEARCH_SOURCE += [ FDirName VCC ] ;
	local SHARED = [ Glob VCC : $(shared) ] ;
	SRCS += $(SHARED) ;

	SubDirLinkLibs $(libs) ;
	SubDirLinkFlags /DLL /DYNAMICBASE /SUBSYSTEM:CONSOLE ;
	ConfigureBuild ;

	local SUFEXE = .dll ;

	ConfigMain $(CONFIGS) : $(name) : $(SRCS) ;

	ForEachConfig $(CONFIGS) : MakeDllExtras ;
}

rule BuildCommonDll name : shared : libs
{
	SubDir TOP $(name) ;

	local SEARCH_SOURCE = [ FDirName VCC libcommon src ] ;
	local SRCS = [ Glob $(SEARCH_SOURCE) : *.cpp ] ;

	# shared 
	SEARCH_SOURCE += [ FDirName VCC libcommon src core ] ;
	local SHARED = [ Glob $(SEARCH_SOURCE[2]) : *.cpp ] ;
	SRCS += $(SHARED) ;

	SEARCH_SOURCE += [ FDirName VCC libcommon src core cartridges ] ;
	local SHARED = [ Glob $(SEARCH_SOURCE[3]) : *.cpp ] ;
	SRCS += $(SHARED) ;

	ConfigSubDirC++Flags $(CONFIGS) : /DLIBCOMMON_EXPORTS ;
	SubDirLinkLibs $(libs) ;
	SubDirLinkFlags /DLL /DYNAMICBASE /SUBSYSTEM:CONSOLE ;
	ConfigureBuild ;

	local SUFEXE = .dll ;

	ConfigMain $(CONFIGS) : $(name) : $(SRCS) ;

	ForEachConfig $(CONFIGS) : MakeDllExtras ;

	EchoVar target ;


}

BuildCommonDll libcommon ;


#
# Build cart dlls, some require shared sources and additional libraries.
#

#BuildDll acia : logger.cpp DialogOps.cpp : ws2_32.lib ;
#BuildDll becker : logger.cpp DialogOps.cpp Fileops.cpp : ws2_32.lib ;
#BuildDll fd502 : logger.cpp DialogOps.cpp Fileops.cpp : ws2_32.lib ;
#BuildDll gmc ;
#BuildDll orch90 : Fileops.cpp ;
#BuildDll harddisk : DialogOps.cpp Fileops.cpp ;
#BuildDll mpi : logger.cpp DialogOps.cpp Fileops.cpp ;
#BuildDll ramdisk : logger.cpp DialogOps.cpp Fileops.cpp ;
#BuildDll sdc : logger.cpp DialogOps.cpp Fileops.cpp : Shlwapi.lib Ole32.lib ;
#BuildDll superide : DialogOps.cpp Fileops.cpp ;


